# 音频处理 Gradio UI

音频隐私信息检测与匿名化工具的Web界面，基于 AudioProcessor 实现，提供与 `test_audio_processor_basic.py` 相同的功能。

## 🌟 主要功能

### 核心处理功能
- **🎙️ 语音转录**: 使用 WhisperX 模型将音频转换为文字，支持多种语言自动检测
- **👥 说话人分离**: 使用 Pyannote 模型识别音频中的不同说话人（可选）
- **🔍 PII检测**: 在转录文本中检测个人隐私信息
- **🔇 音频匿名化**: 对包含PII的音频片段用蜂鸣声进行替换

### UI增强功能
- **📋 实时处理日志**: 显示详细的处理进度和步骤信息
- **⏱️ 性能监控**: 展示每个处理阶段的耗时
- **📊 详细统计**: 提供全面的处理结果统计
- **🎵 音频播放**: 支持原始和匿名化音频的在线播放

## 🚀 快速开始

### 启动UI
```bash
# 方法1：直接运行主模块
python src/app/tabs/audio_tab/audio_tab.py

# 方法2：运行测试脚本
python src/app/tabs/audio_tab/test_ui.py

# 方法3：运行演示脚本（推荐）
python src/app/tabs/audio_tab/demo.py
```

### 访问界面
- 本地访问：http://localhost:7862
- UI会自动在浏览器中打开

## 📖 使用指南

### 1. 音频输入
- 支持格式：MP3, WAV, FLAC, M4A, OGG
- 推荐采样率：16kHz 或更高
- 建议时长：不超过10分钟（性能考虑）

### 2. 处理配置
- **说话人分离**：启用后可识别不同说话人（会增加处理时间）
- **输出目录**：指定匿名化音频的保存位置

### 3. 结果查看
界面提供6个结果标签页：

#### 🎙️ 转录结果
- 显示检测到的语言
- 按时间段显示转录文本
- 包含时间戳信息

#### 👥 说话人分离
- 显示检测到的说话人数量
- 每个说话人的时间段信息
- 说话人标识和持续时间

#### 🔍 PII检测
- 列出检测到的PII实体
- 显示实体类型、位置、置信度
- 支持的PII类型包括：
  - 人名、电话号码、邮箱地址
  - 身份证号、银行账号、信用卡号
  - 地理位置、组织机构、日期时间等

#### 📊 统计信息
- 总处理时间和各阶段耗时
- 音频时长和转录统计
- PII实体数量和类型分布
- 匿名化处理状态

#### 🔇 匿名化音频
- 播放匿名化后的音频文件
- 显示输出文件路径
- 支持下载功能

#### 📋 处理日志（新功能）
- **实时进度显示**：显示当前处理步骤
- **详细日志信息**：包含每个阶段的状态更新
- **错误诊断**：出现问题时显示详细错误信息
- **性能监控**：显示各步骤的处理时间

## 📋 处理日志功能详解

### 日志内容包括：
1. **开始/结束时间戳**
2. **处理步骤进度**：
   - 🎙️ 语音转录开始/完成
   - 👥 说话人分离状态
   - 🔍 PII检测结果
   - 🔇 音频匿名化进度
3. **实体检测信息**：显示检测到的PII数量
4. **文件操作记录**：输出目录创建等
5. **性能统计**：总处理时间和各阶段耗时
6. **错误信息**：详细的错误堆栈和诊断信息

### 日志格式示例：
```
[14:30:25] 🚀 开始音频处理 - 2025-05-28 14:30:25
[14:30:25] 📁 创建输出目录: /path/to/output
[14:30:25] 🎵 开始处理音频文件: test_audio.mp3
[14:30:25] ⚙️ 说话人分离: 启用
[14:30:25] 🎙️ 步骤1: 开始语音转录...
[14:30:45] ✅ 语音转录完成
[14:30:50] 👥 步骤2: 说话人分离处理完成
[14:30:51] 🔍 步骤3: PII检测处理完成
[14:30:51] 🔐 检测到 3 个PII实体
[14:30:51] 🔇 步骤4: 开始音频匿名化...
[14:30:55] ✅ 音频匿名化完成
[14:30:55] ⏱️ 总处理时间: 30.25 秒
[14:30:55] ✅ 音频处理完成 - 2025-05-28 14:30:55
```

## 🎯 测试文件

项目提供了测试音频文件：
```
data/audio/source_voices/
├── test_audio2.mp3
├── other_test_files.mp3
└── ...
```

## 🔧 技术架构

### 核心组件
- **AudioProcessor**: 主要的音频处理器
- **WhisperX**: 语音转录引擎
- **Pyannote**: 说话人分离模型
- **TextProcessor**: PII检测引擎
- **VoiceAnonymizer**: 音频匿名化器

### UI组件
- **AudioProcessorTab**: 主要的UI类
- **LogCapture**: 日志捕获器（新功能）
- **Gradio**: Web界面框架

### 新增的日志捕获功能
```python
class LogCapture:
    """日志捕获器，用于捕获处理过程中的日志信息"""
    
    def start_capture(self):
        """开始捕获日志和输出"""
        
    def stop_capture(self):
        """停止捕获日志和输出"""
        
    def add_log(self, message: str):
        """添加日志消息"""
        
    def get_logs(self) -> str:
        """获取所有日志信息"""
```

## ⚡ 性能说明

- **转录**: 通常需要 0.1-0.3 倍的音频时长
- **说话人分离**: 额外增加 0.2-0.5 倍的音频时长
- **PII检测**: 几秒钟内完成
- **音频匿名化**: 取决于检测到的PII数量

## 📝 开发说明

### 文件结构
```
src/app/tabs/audio_tab/
├── __init__.py          # 模块导出
├── audio_tab.py         # 主要UI实现
├── test_ui.py          # UI测试脚本
├── demo.py             # 演示脚本
└── README.md           # 本文档
```

### 主要类和方法
- `AudioProcessorTab`: 主UI类
- `process_audio()`: 核心处理方法（已增强日志功能）
- `LogCapture`: 日志捕获类（新增）
- `create_interface()`: 界面创建方法

### 扩展功能
如需添加新功能，可以：
1. 在 `AudioProcessorTab` 类中添加新方法
2. 在界面中添加新的UI组件
3. 更新事件绑定和数据流

## 🤝 贡献

欢迎提交Issues和Pull Requests来改进这个工具！

## 📄 许可证

遵循项目主体许可证。